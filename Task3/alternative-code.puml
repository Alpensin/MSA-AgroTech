@startuml alternative code diagram AgroTech

' Задаем стиль
!NEW_C4_STYLE=1
!theme C4_violet from ../C4-PlantUML/themes

' Импортируем элементы
!include ../C4-PlantUML/C4_Component.puml

' Определяем акторов

Enterprise_Boundary(farm, "Ферма") {
    System_Boundary(edge_control_system, "Управление edge-устройствами"){
      Container_Boundary(edge_control_components, "API управления edge-устройствами") {
        Container_Boundary(device_manager, "Менеджер устройств", "Go", "Регистрация и отслеживание устройств") {
            Component(device_service, "DeviceService", "Бизнес-логика устройств")
            Component(device_repository, "DeviceRepository", "Доступ к данным")
            Component(status_repository, "StatusRepository", "Доступ к данным")
            Component(schedule_repository, "ScheduleRepository", "Доступ к данным")
            Component(health_checker, "HealthChecker", "Проверка состояния")
        }
        Container_Boundary(command_dispatcher, "Диспетчер команд", "Go", "Отправка управляющих команд") {
            Component(command_service, "CommandService", "Обработка команд")
            Component(protocol_adapter, "ProtocolAdapter", "Адаптер протоколов", "Go interface")
            Component(http_client_cd, "HTTPClient", "HTTP клиент", "Go client")
        }
        Container_Boundary(status_monitor, "Монитор статуса", "Go", "Отслеживание состояния устройств") {
            Component(metrics_collector, "MetricsCollector", "Сбор метрик")
            Component(threshold_checker, "ThresholdChecker", "Проверка порогов")
            Component(alert_detector, "AlertDetector", "Детектор алертов")
        }
        Container_Boundary(schedule_handler, "Обработчик расписаний", "Go", "Обработка изменений расписания") {
            Component(schedule_consumer, "ScheduleConsumer", "Чтение расписаний")
            Component(schedule_processor, "ScheduleProcessor", "Обработка расписаний")
            Component(command_generator, "CommandGenerator", "Генерация команд")
        }
        }
        Container_Boundary(edge_control_db, "Database Layer") {
            Component(devices_table, "devices", "Устройства")
            Component(status_table, "status", "Статусы")
            Component(schedule_table, "schedule", "Расписание")
        }
    }


    Container_Boundary(notification, "Обработчик уведомлений") {
        Container_Boundary(message_router, "Роутер сообщений", "Python", "Маршрутизация уведомлений. Логика повторной отправки") {
            Component(routing_service, "RoutingService", "Управление отправкой", "Python class")
            Component(gateway_adapter, "GatewayAdapter", "Адаптер протоколов", "Python class")
            Component(http_client_notify, "HTTPClient", "HTTP клиент", "Python class")
        }
        Container_Boundary(websocket_handler, "WebSocket сервер", "Python", "Управление WebSocket соединениями") {
            Component(connection_manager, "ConnectionManager", "Python class", "Менеджер соединений")
            Component(session_store, "SessionStore", "Python class", "Хранилище сессий")
        }
        Container_Boundary(notification_reader, "Сборщик уведомлений", "Python", "Чтение уведомлений") {
            Component(notification_consumer, "NotificationConsumer", "RabbitMQ consumer",  "Консьюмер расписаний")
            Component(notification_service, "NotificationService", "Python service", "Сервис расписаний")
        }
    }

    System(farm_sms, "СМС-шлюз", "Служит для отправки уведомлений")
    System(farm_broker, "RabbitMQ", "Точка сбора метрик, событий и уведомлений")
    Person(operator, "Оператор", "Сотрудник на ферме")
    System_Ext(edge_device, "Edge-устройство", "Различные IoT датчики и пульты управления оборудованием")
    System_Ext(vid_mon, "Система видеорегистрации", "Точка сбора видеопотоков с камер")
}

Enterprise_Boundary(center, "Центральный узел") {
    Person(duty, "Дежурная смена", "Состоит из отдельного персонала или дежурных админов и разработчиков")
    System(global_broker, "Kafka", "Точка сбора метрик и уведомлений")
    System(apm, "APM-система", "Собирает метрики, фиксирует аварии, уведомляет")

    Container_Boundary(schedule_api, "API расписаний") {
        Container_Boundary(schedule_manager, "Менеджер расписаний", "Python FastAPI", "Управление расписаниями") {
            Component(schedule_controller, "ScheduleController", "FastAPI router", "Контроллер расписаний")
            Component(schedule_service, "ScheduleService", "Python service", "Сервис расписаний")
        }
        Container_Boundary(schedule_publisher, "Публикатор уведомлений", "Python", "Публикация изменений расписания") {
            Component(message_generator, "MessageGenerator", "Python service", "Генератор сообщений")
            Component(kafka_publisher, "KafkaPublisher", "Python library", "Python class")
        }
    }

    Container_Boundary(vid_mon_anal, "Видеоаналитика ИИ") {
        Container_Boundary(stream_interface, "Прием видеопотоков", "C/C++") {
            Component(stream_receiver, "StreamReceiver", "Прием видеопотоков", "C++ class")
            Component(frame_decoder, "FrameDecoder", "Декодирование кадров", "C++ class")
        }
        Container_Boundary(stream_processor, "Процессор видеопотоков", "C/C++", "Обработка видеопотоков") {
            Component(frame_processor, "FrameProcessor", "Обработка кадров", "C++ class")
        }
        Container_Boundary(object_detector, "Детектор объектов", "Python", "Обнаружение объектов и аномалий") {
            Component(neural_network, "NeuralNetwork", "Нейросетевая модель", "Python class")
            Component(anomaly_detector, "AnomalyDetector", "Детектор аномалий", "Python class")
        }
        Container_Boundary(event_generator, "Генератор событий", "Python", "Создание событий на основе анализа") {
            Component(event_factory, "EventFactory", "Создание событий", "Python class")
            Component(kafka_publisher_vid, "KafkaPublisher", "Python library", "Python class")
        }
    }
}

' Внутренние связи в контейнерах

' Связи edge_control_system
'   Внутри компонентов
'       device_manager
Rel(device_service, device_repository, "Вызывает методы")
Rel(device_repository, devices_table, "Читает/пишет данные")
Rel(device_service, status_repository, "Вызывает методы")
Rel(status_repository, status_table, "Читает/пишет данные")
Rel(health_checker, device_service, "Обновляет статус")
Rel(device_service, schedule_repository, "Читает/обновляет расписание")

'       status_monitor
Rel(metrics_collector, threshold_checker, "Передает метрики в")
Rel(threshold_checker, alert_detector, "Активирует")

'       schedule_handler
Rel(schedule_consumer, schedule_processor, "Передает расписание в")
Rel(schedule_processor, command_generator, "Передает задачу на исполнение")

'       command_dispatcher
Rel(command_service, protocol_adapter, "Использует")
Rel(protocol_adapter, http_client_cd, "Вызывает")z

'       Между компонентами

Rel(schedule_repository, schedule_table, "Читает/пишет данные")
Rel(command_generator, command_service, "Передает команду")
Rel(threshold_checker, device_service, "Получает информацию об устройствах")
Rel(schedule_processor, device_service, "Обновляет расписание")

'       Между контейнерами

Rel(alert_detector, farm_broker, "Передает события")
Rel(schedule_consumer, farm_broker, "Читает события")
Rel(http_client_cd, edge_device, "Устанавливает соединение")

' Связи vid_mon_anal
'   Внутри компонентов
'       stream_interface

Rel(stream_receiver, frame_decoder, "Передает кадры в")

'       object_detector
Rel(anomaly_detector, neural_network, "Анализирует поведение")
'       event_generator
Rel(event_factory, kafka_publisher_vid, "Публикует через")

'       Между компонентами

Rel(frame_decoder, frame_processor, "Передает кадры в")
Rel(frame_processor, anomaly_detector, "Передает кадры в")
Rel(anomaly_detector, event_factory, "Инициализирует создание события")

'       Между контейнерами
Rel(kafka_publisher_vid, global_broker, "Публикует события")


' Связи notification
'   Внутри компонентов
'       message_router

Rel(routing_service, gateway_adapter, "Использует")
Rel(gateway_adapter, http_client_notify, "Вызывает")

'       websocket_handler
Rel(connection_manager, session_store, "Сохраняет сессии в")

'       notification_reader
Rel(notification_service, notification_consumer, "Использует")

'       Между компонентами
Rel(routing_service, connection_manager, "Вызывает")
Rel(notification_service, routing_service, "Вызывает")

'       Между контейнерами
Rel(notification_consumer, farm_broker, "Читает события")
Rel(http_client_notify, farm_sms, "Уведомляет с помощью")
Rel(http_client_notify, operator, "Уведомляет")
Rel(farm_sms, operator, "Отправляет уведомления", "SMS")

'       Между фермой и центральным узлом
Rel(farm_sms, duty, "Отправляет уведомления", "SMS")
Rel(stream_receiver, vid_mon, "Получает видеопотоки", "ONVIF")


' Связи schedule_api
'   Внутри компонентов
'       schedule_manager

Rel(schedule_controller, schedule_service, "Вызывает")

'       schedule_publisher
Rel(message_generator, kafka_publisher, "Вызывает")

'       Между компонентами
Rel(schedule_service, message_generator, "Вызывает")

'       Между контейнерами
Rel(duty, schedule_controller, "Управляет расписанием", "HTTPS")


' Глобальное между фермой и центральным узлом
Rel(kafka_publisher, global_broker, "Отправляет изменения расписания")
Rel(farm_broker, global_broker, "Синхронизирует события", "AMQP")
Rel(apm, global_broker, "Собирает и обрабатывает уведомления и метрики")
Rel(apm, duty, "Отправляет уведомления")